


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Support Chatbot new</title>
    <!-- css file add  -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet" />
    <style>
        /*comman tyle*/
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap');

        textarea {
            width: 100%;
            height: 40%;
            resize: none;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: .5rem 0;
        }

        .toggle-left-panel {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }

        label {
            font-weight: bold;
            text-wrap: nowrap;
        }

        #form1_ddl_systemrole,
        #form1_ddl_knowledgebase {
            width: auto;
        }

        .embedded-video {
            width: 100%;
            height: 315px;
            margin: 10px 0;
        }

        .embedded-image {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
        }

        .imagesetting i {
            font-size: 20px;
            margin-right: 10px;
        }

        /* New Stylish Chatbot Page CSS */

        body {
            font-family: 'Montserrat', sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        pre {
            font-weight: 500;
            text-wrap: wrap;
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
        }

        .content-container {
            display: flex;
            background: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .left-panel {
            background: #2c3e50;
            color: white;
            gap: 10px;
            flex: 2;
            padding: 10px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            border-right: 1px solid #ccc;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            background-color: #e9e9e9;
            flex: 1;
            padding: 10px;
            height: 100vh;
        }



        #chat {
            flex-grow: 1;
            padding: 20px;
            background-color: #fff;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
        }


        .chat-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 600px;
            margin: auto;
            padding: 10px;
        }

        .message {
            max-width: 92%;
            padding: 10px 10px;
            border-radius: 20px;
            /* text-align: justify; */
            font-size: 14px;
            font-weight: 500;
            word-wrap: break-word;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.3s ease-in-out forwards;
            margin: 5px 0;
        }

        /* Bot Message */
        .bot {
            align-self: flex-start;
            border-top-left-radius: 0;
            animation-delay: 0.1s;
            border: 1px solid #ccc;
            font-weight: 500;
        }

        /* User Message */
        .user {
            align-self: flex-end;
            background-color: #967f00;
            /* Cool teal for bot messages */
            color: #ffffff;
            border-top-right-radius: 0;
            animation-delay: 0.2s;
        }

        .top-banner {
            display: flex;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            background: #f39c12;
            padding: 10px;
            border-radius: 10px 10px 0 0;
        }

        iframe {
            width: 100%;
            max-width: 800px;
            /* Adjust as needed */
            aspect-ratio: 16 / 9;
            /* Maintains correct aspect ratio */
            display: block;
            margin: auto;
        }

        .form-select:focus,
        .btn-check:focus + .btn-outline-primary,
        .btn-outline-primary:focus,
        .btn-check:active + .btn-outline-primary:focus,
        .btn-check:checked + .btn-outline-primary:focus,
        .btn-outline-primary.active:focus,
        .btn-outline-primary.dropdown-toggle.show:focus,
        .btn-outline-primary:active:focus {
            border: none;
            outline: 0;
            box-shadow: none !important
        }

        .btn-outline-primary:active:focus {
            box-shadow: none !important;
        }

        /* Fade-in Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .button-container .btn,
        .button-container .form-select {
            padding: 4px 8px;
            font-size: 14px;
            border-radius: 4px;
            /* Slight rounding for a smoother look */
            background-color: #2c3e50;
            /* Muted dark blue-gray */
            color: #ffffff;
            border: none;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .btn-primary,
        .btn-primary:active,
        .btn-primary:focus {
            background-color: #2c3e50;
            /* Muted dark blue-gray */
            color: #ffffff;
            border: none;
            outline: 0;
            box-shadow: none !important
        }

            .btn-primary:hover {
                background-color: #22223b;
                transform: scale(1.05);
            }

        .button-container .btn:hover,
        .button-container .form-select:hover {
            background-color: #22223b;
            /* Darker tone for hover effect */
            transform: scale(1.05);
        }

        /* Make dropdown match button styles */
        .button-container .form-select {
            height: auto;
            width: auto;
        }

        /* Add subtle box shadow for better contrast */
        .button-container .btn,
        .button-container .form-select {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #user-input {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .video-container {
            display: flex;
            justify-content: center;
            padding: 10px;
        }
    </style>
</head>

<body>
    <input type="hidden" value="" id="form2_hdn_message_id" />
    <input type="hidden" value="" id="form3_hdn_message_id" />
    <div id="left-panel" class="left-panel">
        <div class=" d-flex justify-content-between">
            <label class="form-label me-2">System Role</label>
            <select id="form1_ddl_systemrole" class="form-select "></select>
        </div>
        <textarea id="system_role" class="form-control clsvalid" placeholder="Define the role of the chatbot here..."
                  wrap="off" style="overflow-x: auto; white-space: pre;"></textarea>
        <div class=" d-flex justify-content-between align-items-center">
            <label class="me-2">Knowledge Base</label>
            <select id="form1_ddl_knowledgebase" class="form-select"></select>
        </div>
        <textarea id="knowledge_base" class="form-control clsvalid" placeholder="Add the knowledge base content here..."
                  wrap="off" style="overflow-x: auto; white-space: pre;"></textarea>

        <label for="form1_text_temperature" class="form-label me-2">Temperature</label>
        <input type="text" id="form1_text_temperature" class="form-control clsvalid"
               placeholder="Enter temperature (0.1 - 1)" value="0"
               oninput="validateTemperature(this)" onblur="fixTemperature(this)">
        <label for="form1_text_max_tokens" class="form-label me-2">Number of Tokens</label>
        <input type="text" id="form1_text_max_tokens" class="form-control clsvalid"
               placeholder="Enter max tokens (e.g., 200)" value="100"
               onkeypress="return event.charCode >= 48 && event.charCode <= 57"
               maxlength="4">
    </div>
    <div class="right-panel">
        <div class="top-banner">
            <button class="toggle-left-panel imagesetting" onclick="toggleLeftPanel()">
                <i class="fa-solid fa-expand"></i>
            </button>
            Username : Virtual Assistant
        </div>
        <div id="chat">
            <div class="message bot">AI ChatBot for Rohan Saroha - Training Module</div>
        </div>
        <div class="button-container d-flex flex-wrap gap-2" id="form1_ldl_">
            <button class="btn btn-outline-primary" onclick="quickQuery('ProjectOverview')">Project Overview</button>
            <button class="btn btn-outline-primary" onclick="quickQuery('Amenities')">Amenities</button>
            <button class="btn btn-outline-primary" onclick="quickQuery('Location')">Location</button>
            <select class="form-select w-auto" onchange="quickQuery(this.value)">
                <option value="BHK">BHK</option>
                <option value="2BHK">2 BHK</option>
                <option value="3BHK">3 BHK</option>
                <option value="4BHK">4 BHK</option>
            </select>
            <button class="btn btn-outline-primary" onclick="quickQuery('About Rohan Builders')">
                About Rohan
                Builders
            </button>
        </div>
        <div class="input-group mb-3">
            <input type="text" id="form1_text_user_input" class="form-control clsvalid"
                   placeholder="Type your question here...">
            <button class="btn btn-primary" id="send-button">
                <img src="https://img.icons8.com/ios-filled/24/ffffff/paper-plane.png" alt="Send">
            </button>
        </div>
    </div>
    <!-- script file add  -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://misboard.rohanbuilders.com/jscss/cssvalidation.js"></script>
    <script>
        // common function for sending request to server
        $(window).on('load', function () {
            $('#loading').hide();
            //
            var eventvaldld = "Event:BindDropDownSystemRole"
            fnBindDropdownlist("chatgptai", eventvaldld, "#form1_ddl_systemrole", "0", "0", "Select System Role", "");
            var eventvaldld = "Event:BindDropDownKnowledgeBase"
            fnBindDropdownlist("chatgptai", eventvaldld, "#form1_ddl_knowledgebase", "0", "0", "Select Knowledge Base", "");

            var eventpageload = "Event:Bindpageload"
            var getSubmdata_1 = fnsndrequest("chatgptai", eventpageload);
            fnUpdatePageData(getSubmdata_1, "#loading");
        });

        // common function systemrole and knowledgebase dropdown change event
        $("#form1_ddl_systemrole").change(function () {
            var vrprojectid = $(this).val();
            var evevtvaldldl = "Event:BindSystemRole~!form1_ddl_systemrole:" + vrprojectid;
            var getSubmdata_1 = fnsndrequest("chatgptai", evevtvaldldl);
            fnUpdatePageData(getSubmdata_1, "#loading");
        });

        $("#form1_ddl_knowledgebase").change(function () {
            var vrprojectid = $(this).val();
            var evevtvaldldl = "Event:BindKnowledgeBase~!form1_ddl_knowledgebase:" + vrprojectid;
            var getSubmdata_1 = fnsndrequest("chatgptai", evevtvaldldl);
            fnUpdatePageData(getSubmdata_1, "#loading");
        });

        // Handle the Enter key press
        $("#form1_text_user_input").on("keypress", async function (e) {
            if (e.which === 13) { // Enter key
                $('#form1_ddl_systemrole, #form1_ddl_knowledgebase').css('border-color', '');

                let systemRole = $('#system_role').val().trim();
                let knowledgeBase = $('#knowledge_base').val().trim();

                if (systemRole === "" || knowledgeBase === "") {
                    if (systemRole === "") $('#form1_ddl_systemrole').css('border-color', 'red');
                    if (knowledgeBase === "") $('#form1_ddl_knowledgebase').css('border-color', 'red');
                } else {
                    // If both fields are filled, proceed with form submission handling
                    var thcheck = "N";
                    thcheck = IsvalidationForm("form1_"); // Call your custom validation function
                    if (thcheck == "N") {
                        // Handle failure if validation fails
                    } else {
                        // Wait for the form submission process
                        thcheck = await FormSubmissionshandle("form1_", "chatgptai", "#loading", "Event:SubmitUserQuery" + "~!");
                        if (thcheck.indexOf("success") > -1) {
                            // alert(thcheck);
                            var responseMessage2 = thcheck.split("success > ")[1];
                            // alert(responseMessage2);
                            $("#form2_hdn_message_id").val(responseMessage2);
                            handleUserQuery(); // Your custom function to handle user query
                        } else {
                            // Handle failure response if needed
                        }
                    }
                }
            }
        });

        // function to validate temperature input
        function validateTemperature(input) {
            let value = input.value.trim();

            // Allow only numbers and a single decimal point
            if (!/^\d*\.?\d*$/.test(value)) {
                input.value = value.slice(0, -1); // Remove last invalid character
                return;
            }
        }


        // function to fix temperature input
        function fixTemperature(input) {
            let num = parseFloat(input.value);

            // List of allowed values (0.1 to 1 in 0.1 steps)
            let allowedValues = ["0", "0.1", "0.2", "0.3", "0.4", "0.5", "0.6", "0.7", "0.8", "0.9", "1.0"];

            // Auto-correct to nearest allowed value if needed
            if (isNaN(num) || num < 0) {
                input.value = "0"; // Set minimum valid value
            } else if (num > 1) {
                input.value = "1.0"; // Set maximum valid value
            } else {
                input.value = num.toFixed(1); // Fix formatting (e.g., "0.3" instead of "0.30")
            }

            // Ensure only allowed values remain
            if (!allowedValues.includes(input.value)) {
                input.value = "0"; // Default to minimum valid value
            }
        }


        // function to validate max tokens input
        function toggleLeftPanel() {
            const leftPanel = document.getElementById('left-panel');
            leftPanel.style.display = (leftPanel.style.display === 'none' || leftPanel.style.display === '') ? 'flex' : 'none';
        }
        // Function to quickly query the chatbot
        function quickQuery(query) {
            if (query) {
                const userInput = document.getElementById('form1_text_user_input');
                userInput.value = query;
                userInput.dispatchEvent(new KeyboardEvent('keypress', { key: 'Enter', which: 13 }));
            }
        }
        // Function to get the system input





        // Bind click event to the send button
        $("#send-button").click(async function () {



         

         
            $('#form1_ddl_systemrole, #form1_ddl_knowledgebase').css('border-color', '');

            let systemRole = $('#system_role').val().trim();
            let knowledgeBase = $('#knowledge_base').val().trim();

            if (systemRole === "" || knowledgeBase === "") {
                if (systemRole === "") $('#form1_ddl_systemrole').css('border-color', 'red');
                if (knowledgeBase === "") $('#form1_ddl_knowledgebase').css('border-color', 'red');
            } else {
                // If both fields are filled, proceed with form submission handling
                var thcheck = "N";
                thcheck = IsvalidationForm("form1_"); // Call your custom validation function
                if (thcheck == "N") {
                    // Handle failure if validation fails
                } else {
                    // Wait for the form submission process
                    thcheck = await FormSubmissionshandle("form1_", "chatgptai", "#loading", "Event:SubmitUserQuery" + "~!");
                    if (thcheck.indexOf("success") > -1) {
                        // alert(thcheck);
                        var responseMessage2 = thcheck.split("success > ")[1];
                        // alert(responseMessage2);
                        $("#form2_hdn_message_id").val(responseMessage2);
                        handleUserQuery(); // Your custom function to handle user query
                    } else {
                        // Handle failure response if needed
                    }
                }
            }
        });



        function getSystemInput() {
            const systemRole = $("#system_role").val().trim();
            const knowledgeBase = $("#knowledge_base").val().trim();
            return `${systemRole}\n\nKNOWLEDGE BASE:\n${knowledgeBase}`;
        }

        let conversationHistory = [];
        async function queryChatbot(userQuery) {
                                        // Example value for eventval
    var eventval = "Event:bindkey";

// Assuming fnsndrequest is a function that retrieves the API response
var getSubmdata = fnsndrequest("chatgptai", eventval);



  // Clean up the response string by removing brackets if they exist
  getSubmdata = getSubmdata.replace(/\[|\]/g, "");

// Function to extract a specific key's value from the response string
const vrkey = getValueByKey(getSubmdata, "Column1");


            let systemInput = getSystemInput();
            let temperature = parseFloat($("#form1_text_temperature").val()) || 0;
            let maxTokens = parseInt($("#form1_text_max_tokens").val()) || 300;

            let body = {
                model: "gpt-3.5-turbo",
                messages: [{ role: "system", content: systemInput }, ...conversationHistory, { role: "user", content: userQuery }],
                temperature: temperature,
                max_tokens: maxTokens,
            };

            console.log("API Request Body:", JSON.stringify(body, null, 2));

            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${vrkey}`, // Replace with your actual API key
                    },      
                    body: JSON.stringify(body),
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log("API Response:", data);

                if (data.choices && data.choices.length > 0) {
                    let botResponse = data.choices[0].message.content.trim();

                    // Update conversation history (keeping last 10 messages)
                    conversationHistory.push({ role: "user", content: userQuery });
                    conversationHistory.push({ role: "assistant", content: botResponse });

                    if (conversationHistory.length > 10) {
                        conversationHistory = conversationHistory.slice(-10);
                    }

                    let thcheck = IsvalidationForm("form2_"); // Ensure `thcheck` is defined

                    if (thcheck !== "N") {
                        let eventvaldld = `Event:Submitbotresponse~!Responsebot:${botResponse}~!`;
                        thcheck = await FormSubmissionshandle("form2_", "chatgptai", "#loading", eventvaldld);

                        // console.log("1-"+thcheck);
                        if (thcheck.includes("success")) {

                            let varResponsebot = thcheck.split("success > ")[1];
                            console.log(varResponsebot);
                            console.log("Bot Response Saved:", varResponsebot);
                            $("#form3_hdn_message_id").val(varResponsebot);
                            botResponse = varResponsebot;
                            // console.log("2-"+ thcheck);
                        } else {
                            console.error("Error in bot response submission.");
                        }
                    }

                    return botResponse;
                } else {
                    throw new Error("No valid response from API");
                }
            } catch (error) {
                console.error("Error:", error);
                return "I'm sorry, there was an error processing your request.";
            }
        }

        function appendMessage(role, message) {
            let messageClass = role === "user" ? "message user" : "message bot";
            $("#chat").append(`<div class='${messageClass}'><pre>${message}</pre></div>`);
            $("#chat").scrollTop($("#chat")[0].scrollHeight);
        }

        function handleUserQuery() {
            let userQuery = $("#form1_text_user_input").val().trim();
            if (userQuery !== "") {
                appendMessage("user", userQuery);
                $("#form1_text_user_input").val("");

                queryChatbot(userQuery).then(botResponse => {
                    appendMessage("bot", botResponse);
                }).catch(() => {
                    appendMessage("bot", "I'm sorry, there was an error processing your request.");
                });
            }
        }

   
        

    </script>

</body>

</html>



